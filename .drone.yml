kind: pipeline
name: default
workspace:
  base: /go
  path: src/github.com/cblomart/vsphere-graphite

steps:
  # check dependencies
  - dependancies:
    name: Restore Dependances
    image: cblomart/gobasebuild
    commands:
    - go version
    - make godeps
    - go generate ./...
  # do the checkups
  - checkups:
    name: Golang Checkups
    image: cblomart/gobasebuild
    commands:
    - make checks
  # buils
  - buildlin:
    name: Build Linux AMD64
    group: build
    image: cblomart/gobasebuild
    commands:
    - make build-linux-amd64
  - buildwin:
    name: Build Windows AMD64
    group: build
    image: cblomart/gobasebuild
    commands:
    - make build-windows-amd64
    when:
      event: [ tag ]
  - buildosx:
    name: Build OSX AMD64
    group: build
    image: cblomart/gobasebuild
    commands:
    - make build-darwin-amd64
    when:
      event: [ tag ]
  - buildarm:
    name: Build Linux ARM
    group: build
    image: cblomart/gobasebuild
    commands:
    - make build-linux-arm
    when:
      event: [ tag ]
  # push to docker
  - pushlin:
    group: push
    name: Docker Push Linux AMD64
    image: cblomart/gobasebuild
    secrets: [ docker_password ]
    volumes:
    - name: docker
      path: /var/run/docker.sock
    commands:
    - make docker-linux-amd64
    - docker login -u cblomart -p $DOCKER_PASSWORD
    - make push-linux-amd64
  - pusharm:
    group: push
    name: Docker Push Linux ARM
    image: cblomart/gobasebuild
    secrets: [ docker_password ]
    volumes:
    - name: docker
      path: /var/run/docker.sock
    commands:
    - make docker-linux-arm
    - docker login -u cblomart -p $DOCKER_PASSWORD
    - make push-linux-arm
    when:
      event: [ tag ]
  - packlin:
    name: Package Linux AMD64
    group: pack
    image: cblomart/gobasebuild
    commands:
    - make dist-linux-amd64
    - cp /tmp/vsphere-graphite_*.tgz releases/
    when:
      event: [ tag ]
  - packwin:
    name: Package Windows AMD64
    group: pack
    image: cblomart/gobasebuild
    commands:
    - make dist-windows-amd64
    - cp /tmp/vsphere-graphite_*.tgz releases/
    when:
      event: [ tag ]
  - packosx:
    name: Package OSX AMD64
    group: pack
    image: cblomart/gobasebuild
    commands:
    - make dist-darwin-amd64
    - cp /tmp/vsphere-graphite_*.tgz releases/
    when:
      event: [ tag ]
  - packarm:
    name: Package Linux ARM
    group: pack
    image: cblomart/gobasebuild
    commands:
    - make dist-linux-arm
    - cp /tmp/vsphere-graphite_*.tgz releases/
    when:
      event: [ tag ]
  - release:
    name: release
    image: plugins/github-release
    secrets: [ github_token ]
    files:
      - releases/*.tgz
    checksum:
      - sha256
    when:
      event: [ tag ]

volumes:
  - name: docker
    host:
      path: /var/run/docker.sock
