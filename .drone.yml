workspace:
  base: /go
  path: src/github.com/cblomart/vsphere-graphite

# Build vsphere-graphite with drone.

pipeline:
  # perpare a helper image with necessary tooling deps included
  supportvm:
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    image: alpine
    commands:
    - apk add --no-cache docker
    - docker build -f docker/helper/Dockerfile -t cblomart/helper-vsphere-graphite docker/main
  # do the checkups
  dependancies:
    image: cblomart/helper-vsphere-graphite
    volumes:
      - /var/volumes/dronecache:/cache
    commands:
    - if [ -f /cache/vsphere-graphite-deps.tgz ]; then tar -zxf /cache/vsphere-graphite-deps.tgz -C /go/; fi
    - make deps
    - tar -zcf /tmp/vsphere-graphite-deps.tgz -C /go/ --exclude=*/vsphere-graphite* ./
    - md5sum /tmp/vsphere-graphite-deps.tgz  | egrep -o '^[A-Fa-f0-9]+' > /tmp/vsphere-graphite-deps.md5
    - if [ ! -f /cache/vsphere-graphite-deps.tgz ]; then cp -f /tmp/vsphere-graphite-deps.* /cache/; fi
    - if ! cmp -s /cache/vsphere-graphite-deps.md5 /tmp/vsphere-graphite-deps.md5; then cp -f /tmp/vsphere-graphite-deps.* /cache/; fi
  checkups:
    image: cblomart/helper-vsphere-graphite
    commands:
    - make checks
  # buils
  buildlin:
    group: build
    image: cblomart/helper-vsphere-graphite
    commands:
    - make build-linux-amd64
  buildwin:
    group: build
    image: cblomart/helper-vsphere-graphite
    commands:
    - make build-windows-amd64
    when:
      event: [ tag ]
  buildosx:
    group: build
    image: cblomart/helper-vsphere-graphite
    commands:
    - make build-darwin-amd64
    when:
      event: [ tag ]
  buildarm:
    group: build
    image: cblomart/helper-vsphere-graphite
    commands:
    - make build-linux-arm
    when:
      event: [ tag ]
  # push to docker
  pushlin:
    group: push
    name: Docker Push Linux AMD64
    image: cblomart/helper-vsphere-graphite
    environment:
      - DOCKER_HOST=unix:///drone/docker.sock
    commands:
    - make push-linux-amd64

services:
  docker:
    image: docker:dind
    privileged: true
    command: [ '-H', 'unix:///drone/docker.sock' ]